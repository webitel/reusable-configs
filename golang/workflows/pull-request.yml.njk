{% import "./_defaults.njk" as defs -%}

name: PR ({{ name }})

on:
  pull_request:

permissions: { contents: read }
concurrency:
  group: {{ "${{ github.workflow }}-${{ github.event.pull_request.number }}" }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare
    uses: webitel/reusable-workflows/.github/workflows/golang-prepare.yml@{{ defs.workflow.version }}
    with:
      development-branch: {{ "${{ github.event.repository.default_branch }}" }}
      triggered-branch: " ${{ github.event.pull_request.base.ref }} "

  checks:
    name: Checks
    needs: [ prepare ]
    uses: webitel/reusable-workflows/.github/workflows/golang-checks.yml@{{ defs.workflow.version }}
    permissions:
      contents: read
      actions: read
      security-events: write

  compile:
    name: Build
    needs: [ prepare ]
    uses: webitel/reusable-workflows/.github/workflows/golang-build.yml@{{ defs.workflow.version }}
    with:
      binary-name: {{ build["binary-name"] }}
      ldflags: >
        {{ build["ldflags"] | safe | indent(8) }}

      version: {{ "${{ needs.prepare.outputs.version }}" }}
      version-build: {{ "${{ github.run_number }}" }}
      version-metadata: {{ "pr${{ github.event.pull_request.number }}" }}
      prerelease: {{ "${{ github.event.repository.default_branch == github.event.pull_request.base.ref && 'dev' || '' }}" | safe }}
      package-name: {{ "${{ vars.SERVICE_NAME }}" }}
      package-description: {{ "${{ github.event.repository.description }}" }}
      package-contents: |
        {{ build["package-contents"] | safe | indent(8) }}

      scripts: |
        {{ build["scripts"] | safe | indent(8) }}

  publish:
    name: Publish .deb package
    needs: [ compile ]
    uses: webitel/reusable-workflows/.github/workflows/_publish-deb.yml@{{ defs.workflow.version }}
    with:
      deb-package-pattern: {{ name }}*.deb
      deb-component: {{ "${{ github.event.repository.default_branch == github.ref_name && 'dev' || format('{0}-releases', needs.prepare.outputs.version) }}" | safe }}
      deb-codename: {{ "${{ vars.DEB_CODENAME }}" }}
      deb-aws-bucket-name: {{ "${{ vars.DEB_AWS_BUCKET_NAME }}" }}
      deb-aws-bucket-region: {{ "${{ vars.DEB_AWS_DEFAULT_REGION }}" }}
